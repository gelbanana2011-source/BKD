<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ãƒªãƒ¼ãƒ€ãƒ¼å°‚ç”¨ãƒ¬ã‚¸</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f0f2f5; }
        
        /* ãƒ¡ã‚¤ãƒ³ã®å…¥åŠ›ã‚¨ãƒªã‚¢ã‚’ç›®ç«‹ãŸã›ã‚‹ */
        .scan-area {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
            margin-bottom: 20px;
            border: 2px solid #007bff;
        }

        /* ã‚¹ã‚­ãƒ£ãƒ³å…¥åŠ›æ¬„ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        #main-input {
            width: 80%;
            padding: 15px;
            font-size: 1.5rem;
            text-align: center;
            border: 2px solid #ccc;
            border-radius: 8px;
            outline: none;
        }
        #main-input:focus { border-color: #007bff; background-color: #eef7ff; }
        
        /* ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ */
        .mode-switch { margin-bottom: 15px; }
        label { margin-right: 15px; font-size: 1.2rem; cursor: pointer; padding: 5px 10px; border-radius: 5px; }
        input[type="radio"] { transform: scale(1.5); margin-right: 5px; }
        
        /* é¸æŠä¸­ã®ãƒ¢ãƒ¼ãƒ‰ã®è‰² */
        .mode-wrapper { background: white; padding: 10px; border-radius: 8px; display: inline-block; }
        
        /* ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ãƒªã‚¹ãƒˆ */
        table { width: 100%; border-collapse: collapse; background: white; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #f8f9fa; }
        
        .total-area { font-size: 2rem; font-weight: bold; text-align: right; margin: 20px 0; color: #d9534f; }
        
        /* ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆæœ€åˆã¯éš ã™ï¼‰ */
        #register-dialog {
            display: none;
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; padding: 30px; border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.3); z-index: 100; width: 300px;
        }
        #overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 50;
        }
        
        .btn { padding: 10px 20px; cursor: pointer; font-size: 1rem; border: none; border-radius: 4px; color: white; margin-top: 10px; }
        .btn-save { background: #28a745; width: 100%; }
        .btn-cancel { background: #6c757d; margin-top: 5px; width: 100%; }
        .btn-reset { background: #dc3545; font-size: 0.8rem; margin-top: 30px; }
        
        input.form-input { width: 100%; padding: 8px; margin-bottom: 10px; box-sizing: border-box; font-size: 1rem; }
    </style>
</head>
<body>

    <h1 style="text-align:center;">ğŸ›’ ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ãƒªãƒ¼ãƒ€ãƒ¼ãƒ»ãƒ¬ã‚¸</h1>

    <div style="text-align: center;">
        <div class="mode-wrapper">
            <label><input type="radio" name="mode" value="purchase" checked onchange="setFocus()"> â‘  ãƒ¬ã‚¸ãƒ¢ãƒ¼ãƒ‰ï¼ˆè³¼å…¥ï¼‰</label>
            <label><input type="radio" name="mode" value="register" onchange="setFocus()"> â‘¡ ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰</label>
        </div>
    </div>

    <div class="scan-area">
        <p>ã“ã“ã«ã‚«ãƒ¼ã‚½ãƒ«ã‚’ç½®ã„ã¦ã€Œãƒ”ãƒƒã€ã¨ã—ã¦ãã ã•ã„</p>
        <input type="text" id="main-input" placeholder="ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³" autofocus autocomplete="off">
        <div id="message" style="margin-top:10px; color: blue; font-weight:bold; height: 1.2em;"></div>
    </div>

    <div id="cart-area">
        <h3>ãŠè²·ã„ç‰©ãƒªã‚¹ãƒˆ</h3>
        <table>
            <thead>
                <tr><th>å•†å“å</th><th>å˜ä¾¡</th><th>å‰Šé™¤</th></tr>
            </thead>
            <tbody id="cart-list"></tbody>
        </table>
        <div class="total-area">åˆè¨ˆ: Â¥<span id="total-price">0</span></div>
        <button class="btn btn-save" onclick="checkout()">ä¼šè¨ˆå®Œäº†</button>
        <button class="btn btn-reset" onclick="resetData()">å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ï¼ˆç®¡ç†è€…ç”¨ï¼‰</button>
    </div>

    <div id="overlay"></div>
    <div id="register-dialog">
        <h3>æ–°è¦å•†å“ç™»éŒ²</h3>
        <p>ã‚³ãƒ¼ãƒ‰: <b id="reg-code-display"></b></p>
        <input type="text" id="reg-name" class="form-input" placeholder="å•†å“åã‚’å…¥åŠ›">
        <input type="number" id="reg-price" class="form-input" placeholder="ä¾¡æ ¼ã‚’å…¥åŠ›">
        <button class="btn btn-save" onclick="saveProduct()">ä¿å­˜ã™ã‚‹</button>
        <button class="btn btn-cancel" onclick="closeRegisterDialog()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>

    <script>
        // --- ãƒ‡ãƒ¼ã‚¿ç®¡ç† ---
        let products = JSON.parse(localStorage.getItem('shopData')) || {};
        let cart = [];
        let tempRegCode = ""; // ç™»éŒ²ä¸­ã®ã‚³ãƒ¼ãƒ‰ä¸€æ™‚ä¿å­˜

        // --- åˆæœŸåŒ– ---
        const mainInput = document.getElementById('main-input');
        
        // ç”»é¢ã‚¯ãƒªãƒƒã‚¯ã§ã™ãå…¥åŠ›æ¬„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ï¼ˆä¾¿åˆ©æ©Ÿèƒ½ï¼‰
        document.body.addEventListener('click', (e) => {
            if(e.target.tagName !== 'INPUT' && e.target.tagName !== 'BUTTON') {
                mainInput.focus();
            }
        });

        // --- ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆEnterã‚­ãƒ¼ï¼‰æ¤œçŸ¥ ---
        mainInput.addEventListener('keydown', function(e) {
            // ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ãƒªãƒ¼ãƒ€ãƒ¼ã¯æœ€å¾Œã«Enterã‚­ãƒ¼ã‚’é€ä¿¡ã™ã‚‹ã“ã¨ãŒå¤šã„
            if (e.key === 'Enter') {
                const code = mainInput.value.trim();
                if (code) {
                    handleScan(code);
                }
                mainInput.value = ''; // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
            }
        });

        // --- ã‚¹ã‚­ãƒ£ãƒ³å‡¦ç†ã®åˆ†å² ---
        function handleScan(code) {
            const mode = document.querySelector('input[name="mode"]:checked').value;
            const product = products[code];

            if (mode === 'purchase') {
                // è³¼å…¥ãƒ¢ãƒ¼ãƒ‰
                if (product) {
                    addToCart(product);
                    showMessage(`ã€Œ${product.name}ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸ`);
                } else {
                    playSound('error');
                    alert(`æœªç™»éŒ²ã®å•†å“ã§ã™ï¼\nã‚³ãƒ¼ãƒ‰: ${code}\nã€Œç™»éŒ²ãƒ¢ãƒ¼ãƒ‰ã€ã«åˆ‡ã‚Šæ›¿ãˆã¦ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚`);
                }
            } else {
                // ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰
                if (product) {
                    // æ—¢ã«ç™»éŒ²æ¸ˆã¿ãªã‚‰ç·¨é›†ã™ã‚‹ã‹èã
                    openRegisterDialog(code, product.name, product.price);
                    showMessage(`ç™»éŒ²æ¸ˆã¿: ${product.name}`);
                } else {
                    // æ–°è¦ç™»éŒ²
                    openRegisterDialog(code, '', '');
                }
            }
        }

        // --- ã‚«ãƒ¼ãƒˆæ©Ÿèƒ½ ---
        function addToCart(product) {
            cart.push(product);
            renderCart();
            playSound('success');
        }

        function renderCart() {
            const tbody = document.getElementById('cart-list');
            tbody.innerHTML = '';
            let total = 0;
            
            cart.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.name}</td>
                    <td>Â¥${item.price}</td>
                    <td><button onclick="removeFromCart(${index})" style="background:#dc3545; color:white; border:none;">Ã—</button></td>
                `;
                tbody.appendChild(tr);
                total += parseInt(item.price);
            });
            document.getElementById('total-price').innerText = total.toLocaleString();
        }

        function removeFromCart(index) {
            cart.splice(index, 1);
            renderCart();
            mainInput.focus();
        }

        function checkout() {
            if(cart.length === 0) return;
            if(confirm('ä¼šè¨ˆã‚’å®Œäº†ã—ã¦ã‚«ãƒ¼ãƒˆã‚’ç©ºã«ã—ã¾ã™ã‹ï¼Ÿ')) {
                cart = [];
                renderCart();
                showMessage("ä¼šè¨ˆå®Œäº†ã—ã¾ã—ãŸï¼");
            }
            mainInput.focus();
        }

        // --- ç™»éŒ²æ©Ÿèƒ½ ---
        function openRegisterDialog(code, name, price) {
            tempRegCode = code;
            document.getElementById('reg-code-display').innerText = code;
            document.getElementById('reg-name').value = name;
            document.getElementById('reg-price').value = price;
            
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('register-dialog').style.display = 'block';
            
            // å•†å“åå…¥åŠ›æ¬„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç§»å‹•
            document.getElementById('reg-name').focus();
        }

        function saveProduct() {
            const name = document.getElementById('reg-name').value;
            const price = document.getElementById('reg-price').value;
            
            if(!name || !price) return alert('å•†å“åã¨ä¾¡æ ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            
            products[tempRegCode] = { name, price };
            localStorage.setItem('shopData', JSON.stringify(products));
            
            alert(`ã€Œ${name}ã€ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼`);
            closeRegisterDialog();
            playSound('success');
        }

        function closeRegisterDialog() {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('register-dialog').style.display = 'none';
            mainInput.value = '';
            mainInput.focus(); // ã‚¹ã‚­ãƒ£ãƒ³å¾…ã¡ã«æˆ»ã‚‹
        }

        function resetData() {
            if(confirm('ç™»éŒ²å•†å“ã‚’å…¨ã¦æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿï¼ˆå¾©å…ƒã§ãã¾ã›ã‚“ï¼‰')) {
                localStorage.removeItem('shopData');
                products = {};
                location.reload();
            }
        }

        // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---
        function showMessage(msg) {
            const el = document.getElementById('message');
            el.innerText = msg;
            setTimeout(() => { el.innerText = ''; }, 3000);
        }

        function playSound(type) {
            // ç°¡æ˜“çš„ãªãƒ“ãƒ¼ãƒ—éŸ³ï¼ˆå¿…è¦ãªã‘ã‚Œã°å‰Šé™¤å¯ï¼‰
            // å®Ÿéš›ã®ç¾å ´ã§ã¯ãƒªãƒ¼ãƒ€ãƒ¼è‡ªä½“ãŒã€Œãƒ”ãƒƒã€ã¨é³´ã‚‹ã®ã§ä¸è¦ãªã“ã¨ãŒå¤šã„
        }

        function setFocus() {
            mainInput.focus();
        }
    </script>
</body>
</html>
