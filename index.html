<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç°¡æ˜“ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ãƒ¬ã‚¸</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background-color: #f4f4f4; }
        h1 { text-align: center; font-size: 1.5rem; }
        
        /* ã‚¿ãƒ–ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .tabs { display: flex; justify-content: space-around; margin-bottom: 20px; }
        .tab-btn { flex: 1; padding: 10px; border: none; background: #ddd; cursor: pointer; font-weight: bold; }
        .tab-btn.active { background: #007bff; color: white; }

        /* ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ã‚¨ãƒªã‚¢ */
        #reader { width: 100%; background: black; margin-bottom: 20px; border-radius: 8px; overflow: hidden; }

        /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ */
        .content { display: none; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .content.active { display: block; }

        /* ãƒ•ã‚©ãƒ¼ãƒ ã¨ãƒªã‚¹ãƒˆ */
        input, button { width: 100%; padding: 10px; margin-bottom: 10px; box-sizing: border-box; }
        button { background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background-color: #218838; }
        button.delete { background-color: #dc3545; margin-top: 5px; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border-bottom: 1px solid #ddd; padding: 8px; text-align: left; }
        .total { font-size: 1.5rem; font-weight: bold; text-align: right; margin-top: 20px; }

        .scanned-code { font-weight: bold; color: #007bff; margin-bottom: 10px; display: block; }
    </style>
</head>
<body>

    <h1>ğŸ“± ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ãƒ¬ã‚¸</h1>

    <div id="reader"></div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('purchase')">â‘  è³¼å…¥ (ãƒ¬ã‚¸)</button>
        <button class="tab-btn" onclick="switchTab('register')">â‘¡ å•†å“ç™»éŒ²</button>
    </div>

    <div id="purchase" class="content active">
        <h2>è²·ã„ç‰©ã‹ã”</h2>
        <p>ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã™ã‚‹ã¨è¿½åŠ ã•ã‚Œã¾ã™ã€‚</p>
        <table>
            <thead>
                <tr><th>å•†å“å</th><th>ä¾¡æ ¼</th></tr>
            </thead>
            <tbody id="cart-list">
                </tbody>
        </table>
        <div class="total">åˆè¨ˆ: Â¥<span id="total-price">0</span></div>
        <button onclick="checkout()">ä¼šè¨ˆã‚’å®Œäº†ã™ã‚‹</button>
        <button class="delete" onclick="clearCart()">ã‚«ãƒ¼ãƒˆã‚’ç©ºã«ã™ã‚‹</button>
    </div>

    <div id="register" class="content">
        <h2>æ–°è¦å•†å“ç™»éŒ²</h2>
        <p>ã‚¹ã‚­ãƒ£ãƒ³ã—ãŸã‚³ãƒ¼ãƒ‰: <span id="reg-barcode-display" class="scanned-code">æœªã‚¹ã‚­ãƒ£ãƒ³</span></p>
        
        <form id="reg-form" onsubmit="registerProduct(event)">
            <input type="hidden" id="reg-barcode" required>
            <input type="text" id="reg-name" placeholder="å•†å“å (ä¾‹: ãŠèŒ¶)" required>
            <input type="number" id="reg-price" placeholder="ä¾¡æ ¼ (ä¾‹: 150)" required>
            <button type="submit">å•†å“ã‚’ä¿å­˜ã™ã‚‹</button>
        </form>

        <h3>ç™»éŒ²æ¸ˆã¿å•†å“ä¸€è¦§</h3>
        <ul id="product-list"></ul>
        <button class="delete" onclick="resetAllData()">å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
    </div>

    <script>
        // --- ãƒ‡ãƒ¼ã‚¿ç®¡ç† ---
        let products = JSON.parse(localStorage.getItem('myShopProducts')) || {};
        let cart = [];
        let currentMode = 'purchase'; // 'purchase' or 'register'
        let isScanning = true; // é€£ç¶šã‚¹ã‚­ãƒ£ãƒ³é˜²æ­¢ç”¨ãƒ•ãƒ©ã‚°

        // --- ã‚¹ã‚­ãƒ£ãƒŠãƒ¼è¨­å®š ---
        const html5QrcodeScanner = new Html5QrcodeScanner(
            "reader", { fps: 10, qrbox: 250 }, /* verbose= */ false);

        function onScanSuccess(decodedText, decodedResult) {
            // é€£ç¶šèª­ã¿å–ã‚Šã‚’é˜²ããŸã‚ã®ç°¡æ˜“ãƒ­ãƒƒã‚¯
            if (!isScanning) return;
            
            // ãƒ“ãƒ¼ãƒ—éŸ³ã®ä»£ã‚ã‚Šã«å°‘ã—åœæ­¢ï¼ˆUXå‘ä¸Šï¼‰
            console.log(`Scan result: ${decodedText}`);

            if (currentMode === 'purchase') {
                addToCart(decodedText);
            } else if (currentMode === 'register') {
                setRegisterCode(decodedText);
            }

            // 1ç§’é–“ã‚¹ã‚­ãƒ£ãƒ³ã‚’ç„¡åŠ¹åŒ–ï¼ˆé€£å†™é˜²æ­¢ï¼‰
            isScanning = false;
            setTimeout(() => { isScanning = true; }, 1000);
        }

        html5QrcodeScanner.render(onScanSuccess);

        // --- è³¼å…¥ãƒ¢ãƒ¼ãƒ‰ã®ãƒ­ã‚¸ãƒƒã‚¯ ---
        function addToCart(code) {
            const product = products[code];
            if (product) {
                cart.push(product);
                renderCart();
                alert(`ã€Œ${product.name}ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸ`);
            } else {
                alert(`æœªç™»éŒ²ã®å•†å“ã§ã™ (ã‚³ãƒ¼ãƒ‰: ${code})\nç™»éŒ²ã‚¿ãƒ–ã‹ã‚‰å•†å“ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚`);
            }
        }

        function renderCart() {
            const tbody = document.getElementById('cart-list');
            tbody.innerHTML = '';
            let total = 0;
            cart.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${item.name}</td><td>Â¥${item.price}</td>`;
                tbody.appendChild(tr);
                total += parseInt(item.price);
            });
            document.getElementById('total-price').innerText = total.toLocaleString();
        }

        function checkout() {
            if (cart.length === 0) return alert('ã‚«ãƒ¼ãƒˆãŒç©ºã§ã™');
            if (confirm(`åˆè¨ˆ Â¥${document.getElementById('total-price').innerText} ã§ã™ã€‚ä¼šè¨ˆã—ã¾ã™ã‹ï¼Ÿ`)) {
                // ã“ã“ã§ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ã™ã‚‹å‡¦ç†ãªã©ã‚’æ›¸ã
                alert('è³¼å…¥ã‚’è¨˜éŒ²ã—ã¾ã—ãŸï¼');
                clearCart();
            }
        }

        function clearCart() {
            cart = [];
            renderCart();
        }

        // --- ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰ã®ãƒ­ã‚¸ãƒƒã‚¯ ---
        function setRegisterCode(code) {
            document.getElementById('reg-barcode').value = code;
            document.getElementById('reg-barcode-display').innerText = code;
            // æ—¢ã«ç™»éŒ²æ¸ˆã¿ãªã‚‰æƒ…å ±ã‚’åŸ‹ã‚ã‚‹
            if (products[code]) {
                document.getElementById('reg-name').value = products[code].name;
                document.getElementById('reg-price').value = products[code].price;
                alert('æ—¢ã«ç™»éŒ²æ¸ˆã¿ã®ã‚³ãƒ¼ãƒ‰ã§ã™ã€‚æƒ…å ±ã‚’æ›´æ–°ã§ãã¾ã™ã€‚');
            } else {
                document.getElementById('reg-name').value = '';
                document.getElementById('reg-price').value = '';
                document.getElementById('reg-name').focus();
            }
        }

        function registerProduct(e) {
            e.preventDefault();
            const code = document.getElementById('reg-barcode').value;
            const name = document.getElementById('reg-name').value;
            const price = document.getElementById('reg-price').value;

            if (!code) return alert('å…ˆã«ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„');

            products[code] = { name, price };
            localStorage.setItem('myShopProducts', JSON.stringify(products));
            
            alert(`ã€Œ${name}ã€ã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼`);
            renderProductList();
            
            // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('reg-form').reset();
            document.getElementById('reg-barcode-display').innerText = 'æœªã‚¹ã‚­ãƒ£ãƒ³';
        }

        function renderProductList() {
            const list = document.getElementById('product-list');
            list.innerHTML = '';
            Object.keys(products).forEach(code => {
                const p = products[code];
                const li = document.createElement('li');
                li.innerText = `${p.name} (Â¥${p.price}) - ${code}`;
                list.appendChild(li);
            });
        }

        function resetAllData() {
            if(confirm('ç™»éŒ²å•†å“ã‚’å…¨ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                localStorage.removeItem('myShopProducts');
                products = {};
                renderProductList();
            }
        }

        // --- ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ ---
        function switchTab(mode) {
            currentMode = mode;
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.content').forEach(content => content.classList.remove('active'));
            
            // å¯¾è±¡ã®ã‚¿ãƒ–ã¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
            event.target.classList.add('active');
            document.getElementById(mode).classList.add('active');
        }

        // åˆæœŸåŒ–
        renderProductList();
    </script>
</body>
</html>
